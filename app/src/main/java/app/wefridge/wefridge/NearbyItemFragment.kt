package app.wefridge.wefridge

import android.os.Bundle
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.fragment.app.Fragment
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.swiperefreshlayout.widget.SwipeRefreshLayout
import app.wefridge.wefridge.databinding.FragmentNerbyItemListBinding
import app.wefridge.wefridge.model.Item
import app.wefridge.wefridge.model.ItemController

/**
 * A fragment representing a list of Items.
 */
class NearbyItemFragment : Fragment() {

    private var _binding: FragmentNerbyItemListBinding? = null
    private val binding get() = _binding!!

    private val values = ArrayList<Item>()
    private val _adapter = ItemRecyclerViewAdapter(values, R.id.action_from_nearby_to_detail)
    private lateinit var scrollListener: EndlessRecyclerOnScrollListener
    private lateinit var refreshLayout: SwipeRefreshLayout

    private var radius: Double = 0.0

    private var loading = false
        set(value) {
            field = value
            refreshLayout.isRefreshing = field
            scrollListener.loading = field
        }

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = FragmentNerbyItemListBinding.inflate(inflater, container, false)

        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        with(binding.list) {
            val linearLayoutManager = LinearLayoutManager(context)
            layoutManager = linearLayoutManager
            adapter = _adapter
            scrollListener = EndlessRecyclerOnScrollListener(linearLayoutManager) {
                loadPage()
            }
            addOnScrollListener(scrollListener)
        }

        refreshLayout = binding.swipe
        with(refreshLayout) {
            setOnRefreshListener {
                radius = 0.0
                loadPage()
            }
            loadPage()
        }
    }

    private fun loadPage() {
        if (loading)
            return
        loading = true
//        Log.v("Auth", "Page: ${lastVisible?.id ?: "new"}")
        ItemController.getNearbyItems({ items ->
            if (items.isEmpty()) {
                loading = false
                return@getNearbyItems
            }
            val oldAmount = values.size

            values.clear()
            values.addAll(items)

            val newSize = items.size

            if (oldAmount > newSize) {
                val diff = oldAmount - newSize
                _adapter.notifyItemRangeRemoved(oldAmount - diff, diff)
            }

            _adapter.notifyItemRangeChanged(0, newSize)

            radius = items.last().distance + 500.0

            loading = false
        }, {
            Log.e("Auth", "nearbyItems", it)
            loading = false
        }, radius)
    }
}